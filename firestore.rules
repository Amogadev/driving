
/**
 * This ruleset enforces a strict user-ownership model for a driving school application.
 * All user-specific data is nested under a user's private document tree, and access is
 * controlled by the user's unique ID present in the document path.
 *
 * Core Philosophy:
 * Users have complete control over their own data. They can create their user profile and
 * manage their own related subcollections (like applicant details and document details).
 * Access by any other user is strictly forbidden.
 *
 * Data Structure:
 * - /users/{userId}: A user's primary profile document.
 * - /users/{userId}/applicant_details/{applicantDetailsId}: Private details for a user's application.
 * - /users/{userId}/llr_document_details/{llrDocumentDetailsId}: Private documents for a user's application.
 * - /llr_applications/{applicationId}: A top-level collection for all LLR applications.
 *
 * Key Security Decisions:
 * - User Isolation: A user can only ever access documents within their own `/users/{userId}` path.
 * - User Listing: All authenticated users can list all users, but cannot write to other users' profiles.
 * - Denormalization for Authorization: The `/llr_applications` collection requires each document to contain an `applicantId` field. This denormalized field is used to grant ownership-based permissions without needing slow, cross-collection lookups. This allows for secure and performant rules.
 * - Default Deny: Any operation not explicitly granted is denied.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Ensures an operation is performed by the owner on an existing document.
     * Prevents modification or deletion of non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Description: Manages user profile documents at path /users/{userId}.
     * - Rule: Any authenticated user can create a new user profile. This is necessary for an admin to create users.
     * - Example (Deny): User 'user_xyz' trying to update the profile of 'user_abc'.
     * - Principle: Allows creation by any signed-in user but restricts read/modify to the owner. Listing all users is allowed for authenticated users.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if isSignedIn();
      allow create: if isSignedIn(); // Allow any authenticated user to create a new user
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * Description: Manages a user's private applicant details at path /users/{userId}/applicant_details/{applicantDetailsId}.
       * - Example (Allow): User 'user_abc' retrieving one of their own applicant detail documents.
       * - Example (Deny): User 'user_xyz' trying to list applicant details for 'user_abc'.
       * - Principle: Restricts access to a user's own data tree. Inherits ownership from the path.
       */
      match /applicant_details/{applicantDetailsId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * Description: Manages a user's private LLR document details at path /users/{userId}/llr_document_details/{llrDocumentDetailsId}.
       * - Example (Allow): User 'user_abc' adding a new document detail record.
       * - Example (Deny): User 'user_xyz' trying to read a document detail record belonging to 'user_abc'.
       * - Principle: Restricts access to a user's own data tree. Inherits ownership from the path.
       */
      match /llr_document_details/{llrDocumentDetailsId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }
    }

    /**
     * Description: Manages LLR (Learner's License) applications at path /llr_applications/{applicationId}.
     * - Example (Allow): An authenticated user creating a new application for themselves, e.g., `db.collection('llr_applications').add({ applicantId: 'user_abc', ... })` where auth.uid is 'user_abc'.
     * - Example (Deny): User 'user_xyz' trying to modify an application where `resource.data.applicantId` is 'user_abc'.
     * - Principle: Enforces document ownership for writes via a denormalized 'applicantId' field. Client queries must filter by this field for list operations to be secure.
     */
    match /llr_applications/{applicationId} {
      // A user can read a single application if they are the owner.
      allow get: if isOwner(resource.data.applicantId);

      // Any authenticated user can query the collection.
      // The client-side code is responsible for filtering by applicantId.
      allow list: if isSignedIn();
      
      // CRITICAL: The document being created MUST have an 'applicantId' field.
      // This is now used by the client to associate applications with users.
      allow create: if isSignedIn() && request.resource.data.applicantId != null;
      
      // CRITICAL: The 'applicantId' field must not be changed after creation.
      allow update: if isExistingOwner(resource.data.applicantId) && request.resource.data.applicantId == resource.data.applicantId;
      
      allow delete: if isExistingOwner(resource.data.applicantId);
    }
  }
}
